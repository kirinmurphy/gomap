<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MapperBoi - No Code Online Map Generator</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link href="/src/templates/dist/output.css" rel="stylesheet">
  </head>

  <body class="text-lg bg-[#071e22] lg:text-xl text-white mb-12">
    <div class="max-w-[800px] mx-auto">
      <header class="text-center py-8 leading-8">
        <h1 class="text-xl mb-2 scale-x-[250%]">MAPPERBOI</h1>
        <p class="text-md mb-2">No Code Online Map Generator</p>
        <p class="text-sm">Sync your google spreadsheet to generate a embeddable map of your locations.</p>
      </header>

      <iframe class="mb-4"
        src="/?sheetId=2PACX-1vTWuDWsI4KEC9QDP-JvcmuXuVqUfpnch5Iyv3Qrq4Iv67R7Onzn4PuuSHpqGkD9kyX2FGN7CCZnZp5f" 
        width="100%" 
        height="300" 
        frameborder="0">
      </iframe>

      <div class="flex flex-col gap-4 leading-8">
        <section class="bg-[#1d5468] p-6 rounded-md ">
          <h2 class="text-3xl font-semibold mb-2">Create your google spreadhseet</h2>
          <ol class="list-decimal list-inside">
            <li>Clone <a href="#" target="_blank" rel="noopener noreferrer" class="underline">this spreadsheet</a> and add your locations</li>
            <li>Publish it: <span class="font-bold">File &gt; Share &gt; Publish To Web</span></li>
          </ol>
        </section>
  
        <section class="bg-[#1d5468] p-6 rounded-md ">
          <h2 class="text-3xl font-semibold mb-2">Add your locations</h2>
          <p class="mb-2">Try the  
            <a href="https://chatgpt.com/g/g-kJ2i1rFDl-location-grabber" target="_blank" rel="noopener noreferrer" class="underline">Location Grabber GPT</a> to get your location data.
          </p>
          <p class="text-xs">(guaranteed 72 1/2% accurate)</p></p>  
        </section>
  
        <section class="bg-[#1d5468] p-6 rounded-md ">
          <h2 class="text-3xl font-semibold mb-2">Sync your spreadsheet</h2>
          <form id="sheetForm">
            <label for="sheetUrl" class="block mb-2">Paste in your spreadsheet URL</label>
            <input type="text" id="sheetUrl" name="sheetUrl" placeholder="https://docs.google.com/spreadsheets/d/e/YOUR_ID/pubhtml" class="w-full p-2 mb-4 text-black" required />
            <div id="urlError" class="text-red-500 mb-4 hidden"></div>
          </form>
        </section>
  
        <section id="addMap" class="bg-[#1d5468] text-white p-6 rounded-md  hidden">
          <h2 class="text-3xl font-semibold mb-2">Great! Your map is ready.</h2>
          <p class="mb-2">Add this code snippet to your website.</p>
          <pre id="embedCode" class="bg-gray-800 text-white text-sm p-4 rounded mb-4 overflow-x-auto"></pre>
          <p class="mb-4 text-xs"><a href="#" target="_blank" rel="noopener noreferrer" class="underline">Get help</a> positioning your iframe in your site</p>
          <div id="mapPreview"></div>
        </section>
      </div>

      <footer class="flex flex-row justify-end gap-3 items-center text-sm text-gray-400 mt-12 px-2 ">
        <a class="hover:text-white" href="https://codethings.net" target="_blank" rel="noopener noreferrer">codethings.net</a>
        <a class="hover:text-white" href="mailto:codethingsdotnet@gmail.com" target="_blank" rel="noopener noreferrer">
          <span class="inline-block text-xl">&#x2709;</span>
        </a>
      </footer>  
    </div>

    <script>
      const validateUrl = (url) => {
        const regex = /^https:\/\/docs\.google\.com\/spreadsheets\/d\/e\/([a-zA-Z0-9-_]+)\/pubhtml$/;
        return regex.test(url) ? url.match(regex)[1] : null;
      };

      const displayError = (message) => {
        const errorElement = document.getElementById("urlError");
        errorElement.textContent = message;
        errorElement.classList.remove("hidden");
      };

      const hideError = () => {
        document.getElementById("urlError").classList.add("hidden");
      };

      const updateEmbedCode = (sheetId) => {
        const urlRoot = window.location.hostname === 'localhost' ? '' : window.location.origin;
        const embedCode = `<iframe
  src="${urlRoot}/?sheetId=${sheetId}"
  width="100%"
  height="300"
  frameborder="0"
></iframe>`;       
          document.getElementById("embedCode").textContent = embedCode;
      };

      const showMapPreview = (sheetId) => {
        const mapPreview = document.getElementById("mapPreview");
        const urlRoot = window.location.hostname === 'localhost' ? '' : window.location.origin;
        mapPreview.innerHTML = `<iframe src="${urlRoot}/?sheetId=${sheetId}" width="100%" height="300" frameborder="0"></iframe>`;
      };

      document.getElementById("sheetUrl").addEventListener("paste", (event) => {
        setTimeout(() => {
          const url = event.target.value;
          const sheetId = validateUrl(url);
          if (!sheetId) {
            displayError("Hate to tell you, but I think you got a bad URL there bud");
            console.log('SHEETID', sheetId);

            return;
          } else {
            hideError();
          }

          htmx.ajax('POST', '/loadLocations', { 
            values: { sheetId },
            swap: 'none', 
            trigger: 'afterSwap' 
          });
          
        }, 0);
      });

      document.body.addEventListener("htmx:afterSwap", (event) => {
        const response = JSON.parse(event.detail.xhr.responseText);
        console.log('RESPONSE', response, response.success);
        if (response.success) {
          hideError();
          document.getElementById("addMap").classList.remove("hidden");
          updateEmbedCode(response.sheetId);
          showMapPreview(response.sheetId);
          setTimeout(() => {
            window.scrollTo({
              top: document.body.scrollHeight,
              behavior: 'smooth'
            });
          }, 200);
        } else {
          displayError(`Unable to update your locations. ${response.error || ""}`);
        }
      });
    </script>
  </body>
</html>

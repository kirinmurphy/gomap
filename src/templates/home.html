<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>MapperBoi - Online Map Generator</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link href="/src/templates/dist/output.css" rel="stylesheet">
  </head>

  <body class="text-lg bg-[#071e22] lg:text-xl text-white font-thin">
    <div class="max-w-[800px] mx-auto">
      <div class="md:h-[100vh] md:flex md:flex-col md:gap-3 md:justify-center md:pb-28">
        <header class="text-center py-8 leading-8">
          <h1 class="inline-block mb-2">
            <span class="inline-block text-xl scale-x-[250%]">MAPPERBOI</span>
            <span< class="inline-block text-xs translate-x-[5rem] translate-y-[-6px] text-orange-400 font-semibold">BETA</span>
          </h1>
          <p class="text-md mb-4">Online Map Generator</p>
          <p class="text-sm">Create an embeddable map for your site with a google spreadsheet.</p>
        </header>
  
        <iframe class="mb-4"
          src="/?sheetId=2PACX-1vTWuDWsI4KEC9QDP-JvcmuXuVqUfpnch5Iyv3Qrq4Iv67R7Onzn4PuuSHpqGkD9kyX2FGN7CCZnZp5f" 
          width="100%" 
          height="300" 
          frameborder="0">
        </iframe>  
      </div>

      <div class="flex flex-col gap-4 leading-8">
        <section class="bg-[#1d5468] p-6 md:rounded-md ">
          <h2 class="text-2xl font-medium mb-2">Create your google spreadhseet</h2>
            Clone 
            <a 
              href="https://docs.google.com/spreadsheets/d/1KX8kjoQ7RxFDh0T8roQ83JwIyd8w8etRIJfdJljCook/edit?pli=1&gid=0#gid=0" 
              target="_blank" 
              rel="noopener 
              noreferrer" 
              class="underline">
              this spreadsheet</a>

            <div class="font-normal">File &gt; Make A Copy</div>
          </li>
        </section>
  
        <section class="bg-[#1d5468] p-6 md:rounded-md ">
          <h2 class="text-2xl font-medium mb-2">Add your locations</h2>
          <p class="mb-2">Try the  
            <a href="https://chatgpt.com/g/g-kJ2i1rFDl-location-grabber" target="_blank" rel="noopener noreferrer" class="underline">Location Grabber GPT</a> to get your location data.
          </p>
          <p class="text-xs">(guaranteed 83 1/2% accurate)</p></p>  
        </section>

        <section class="bg-[#1d5468] p-6 md:rounded-md ">
          <h2 class="text-2xl font-medium mb-2">Publish your spreadsheet</h2>
          <ol class="list-decimal list-inside">
            <li><span class="font-normal">File &gt; Share &gt; Publish To Web</span></li>
            <li>Select <span class="font-normal">Publish</span></li>
            <li>Grab the URL from the popup</li>
          </ol>
        </section>
  
        <section class="bg-[#1d5468] p-6 md:rounded-md">
          <h2 class="text-2xl font-medium mb-2">Sync your spreadsheet</h2>
          <form id="sheetForm">
            <label for="sheetUrl" class="block mb-2">Paste your spreasdheet URL</label>
            <input type="text" id="sheetUrl" name="sheetUrl" placeholder="https://docs.google.com/spreadsheets/d/e/YOUR_ID/pubhtml" class="w-full p-2 mb-4 text-black" required />
            <div id="urlError" class="text-red-500 mb-4 hidden"></div>
            <div id="loadingIndicator" class="hidden">Loading...</div> 
          </form>
        </section>

        <div id="mapContainer"></div>  
      </div>

      <footer class="flex flex-row justify-end gap-3 items-center text-sm text-gray-400 py-[500px] px-2 lg:py-8 ">
        <!-- <a class="hover:text-white" href="https://codethings.net" target="_blank" rel="noopener noreferrer">codethings.net</a> -->
        <a class="flex items-center gap-2 group hover:text-white" href="mailto:codethingsdotnet@gmail.com" target="_blank" rel="noopener noreferrer">
          <span class="invisible group-hover:visible inline-block text-sm">codethingsdotnet@gmail.com</span>
          <span class="inline-block text-xl">&#x2709;</span>
        </a>
      </footer>  
    </div>

    <script>
      const validateUrl = (url) => {
        const regex = /^https:\/\/docs\.google\.com\/spreadsheets\/d\/e\/([a-zA-Z0-9-_]+)\/pubhtml$/;
        return regex.test(url) ? url.match(regex)[1] : null;
      };

      const displayError = (message) => {
        const errorElement = document.getElementById("urlError");
        errorElement.textContent = message;
        errorElement.classList.remove("hidden");
      };

      const hideError = () => {
        document.getElementById("urlError").classList.add("hidden");
      };

      document.getElementById("sheetUrl").addEventListener("paste", (event) => {
        setTimeout(() => {
          const url = event.target.value;
          const sheetId = validateUrl(url);
          if (!sheetId) {
            displayError("Hate to tell you, but I think you got a bad URL there bud");
            console.log('SHEETID', sheetId);

            return;
          } else {
            hideError();
          }

          document.getElementById("loadingIndicator").classList.remove("hidden");

          htmx.ajax('POST', '/updateMapUI', { 
            values: { sheetId },
            target: '#mapContainer',
            swap: 'innerHtml'
          });
          
        }, 0);
      });

      document.getElementById("sheetForm").addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          event.preventDefault(); 
        }
      });

      document.body.addEventListener("htmx:afterSwap", (event) => {
        setTimeout(() => {
          const mapContainer = document.getElementById("mapContainer");
          document.getElementById("loadingIndicator").classList.add("hidden");
          if (mapContainer) {
            const topPosition = mapContainer.getBoundingClientRect().top + window.scrollY - 10;
            window.scrollTo({
              top: topPosition,
              behavior: "smooth"
            });
          }
        }, 100);
      });
    </script>
  </body>
</html>
